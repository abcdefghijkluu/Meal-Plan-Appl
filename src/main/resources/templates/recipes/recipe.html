<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Meal Selection</title>
    <link rel="stylesheet" th:href="@{/style.css}">
    <style>
        /* Scrollable table container */
        .scrollable-table {
            max-height: 700px; /* Adjust height as needed */
            overflow-y: auto;
            border: 1px solid #ccc; /* Optional border for visual clarity */
            margin-bottom: 20px; /* Space between the table and buttons */
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <div>
        <nav>
            <a th:href="@{/}">Home Page</a>
            <a th:href="@{/userhome}">User Home</a>
            <a th:href="@{/recipes/recipe}">Recipes Page</a>
            <a th:href="@{/recipes/filter}">Filter Recipes</a>
        </nav>
    </div>

    <!-- Main Content -->
    <div>
        <h1 class="Headers">Select Meals for <span th:text="${selectedDate}"></span></h1>

        <!-- Form for Submitting Selected Meals -->
        <form th:action="@{/recipes/save}" method="post" id="meal-selection-form">
            <input type="hidden" th:name="mealPlanId" th:value="${mealPlanId}" />
            <input type="hidden" th:name="date" th:value="${selectedDate}" />

            <!-- Scrollable Table -->
            <div class="scrollable-table">
                <table class="Tables">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Recipe Name</th>
                            <th>Instructions</th>
                            <th>Food Origin</th>
                            <th>Food Type</th>
                            <th>Select</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Show message if no recipes are available -->
                        <tr th:if="${#lists.isEmpty(recipes)}">
                            <td colspan="6">No recipes available</td>
                        </tr>

                        <!-- Iterate through recipes and display them -->
                        <tr th:each="recipe : ${recipes}">
                            <td th:text="${recipe.id}"></td>
                            <td th:text="${recipe.recipeName}"></td>
                            <td th:text="${recipe.instructions}"></td>
                            <td th:text="${recipe.category}"></td>
                            <td th:text="${recipe.foodType}"></td>
                            <td>
                                <input type="checkbox" th:name="recipeIds" th:value="${recipe.id}" class="meal-checkbox" />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Save Meals Button -->
            <div>
                <button type="submit" class="done-btn" id="save-btn">Save Meals</button>
            </div>
        </form>
    </div>
</body>
</html>


    <script>
        const MAX_MEALS = 5; // Limit for meals per day

        // Retrieve mealPlanId and selectedDate from sessionStorage
        const mealPlanId = sessionStorage.getItem("mealPlanId");
        const selectedDate = sessionStorage.getItem("selectedDate");

        console.log("Retrieved Meal Plan ID:", mealPlanId); // Debugging log
        console.log("Retrieved Selected Date:", selectedDate); // Debugging log

        if (!mealPlanId) {
            console.error("Missing Meal Plan ID Redirecting to User Home.");
            alert("Meal Plan ID. Redirecting to User Home.");
            window.location.href = "/userhome";
        } 

        if (!selectedDate) {
            console.error("Missing Selected Date. Redirecting to User Home.");
            alert("Date is missing. Redirecting to User Home.");
            window.location.href = "/userhome";
        }
        
        console.log("MealPlanID:", mealPlanId, "SelectedDate:", selectedDate);

        // Populate hidden fields and display the selected date
        document.getElementById("meal-plan-id").value = mealPlanId;
        document.getElementById("meal-date").value = selectedDate;
        document.getElementById("selected-date").textContent = selectedDate;

        // Fetch recipes dynamically
        fetch(`/api/recipes`) 
            .then(response => response.json())
            .then(recipes => {
                const tableBody = document.getElementById("recipe-table-body");
                tableBody.innerHTML = ""; // Clear placeholder text

                if (recipes.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="6">No recipes available</td></tr>`;
                    return;
                }

                recipes.forEach(recipe => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${recipe.id}</td>
                        <td>${recipe.recipeName}</td>
                        <td>${recipe.instructions}</td>
                        <td>${recipe.category}</td>
                        <td>${recipe.foodType}</td>
                        <td>
                            <input type="checkbox" name="recipeIds" value="${recipe.id}" class="meal-checkbox" />
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            })
            .catch(error => {
                console.error("Error fetching recipes:", error);
                alert("Failed to load recipes. Please try again.");
            });

        // Enforce restriction on meal selection
        document.addEventListener("change", (event) => {
            if (event.target.classList.contains("meal-checkbox")) {
                const selectedMeals = document.querySelectorAll('.meal-checkbox:checked').length;
                if (selectedMeals > MAX_MEALS) {
                    alert(`You can only select up to ${MAX_MEALS} meals per day.`);
                    event.target.checked = false; // Undo the selection
                }
            }
        });

        // Save meals and redirect to User Home
        document.getElementById("save-btn").addEventListener("click", () => {
            const selectedRecipes = Array.from(document.querySelectorAll('.meal-checkbox:checked')).map(input => input.value);

            if (selectedRecipes.length === 0) {
                alert("Please select at least one recipe.");
                return;
            }

            const payload = {
                mealPlanId: mealPlanId,
                date: selectedDate,
                recipeIds: selectedRecipes,
            };

            console.log("Saving Payload:", payload);

            fetch('/api/meals/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            })
            .then(response => {
                if (response.ok) {
                    alert('Meals saved successfully!');
                    window.location.href = "/userhome"; // Redirect to User Home
                } else {
                    throw new Error('Failed to save meals');
                }
            })
            .catch(error => {
                console.error('Error saving meals:', error);
                alert('An error occurred. Please try again.');
            });
        });
    </script>
</body>
</html>







